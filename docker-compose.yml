services:
  gpu-agent:
    build:
      context: .
      dockerfile: server/Dockerfile
    container_name: gpu_intelligence_api
    ports:
      - "8000:8000"
    volumes:
      # Montamos el contenido de server/ directamente en /app
      - ./server:/app:Z 
      # Montamos la DB real del repo (solo lectura) dentro del contenedor
      - ./gpu-bd/db/pcbuilder.db:/app/db/pcbuilder.db:ro,Z 
    env_file:
      - .env
    environment:
      - DATABASE_URL=sqlite:////app/db/pcbuilder.db
    restart: unless-stopped

  openwebui:
    image: ghcr.io/open-webui/open-webui:latest
    container_name: openwebui
    ports:
      - "3005:8080"
    environment:
      - OPENAI_API_BASE_URL=http://gpu-agent:8000/v1
      - WEBUI_AUTH=false
      # IMPORTANTE: OpenWebUI necesita una Key aunque sea dummy para el agente
      - OPENAI_API_KEY=token_not_used 
    volumes:
      - openwebui_data:/app/backend/data
    depends_on:
      - gpu-agent
    restart: unless-stopped

volumes:
  openwebui_data:
